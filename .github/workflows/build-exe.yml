name: Build Windows Portable Electron App (Zig Backend)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: electron_app/package.json

      - name: Setup Python (CI helper for Windows PROJ runtime assets)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          # Keep CI on a version that setup-zig reliably resolves on Windows.
          # Local development can still use a newer patch version.
          version: 0.15.1

      - name: Install Electron dependencies
        run: npm --prefix electron_app install

      - name: Prepare Windows PROJ runtime assets
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyproj
          @'
          import shutil
          from pathlib import Path
          import pyproj

          pkg = Path(pyproj.__file__).resolve().parent
          proj_data = pkg / "proj_dir" / "share" / "proj"
          # pyproj wheel layouts vary by platform/version. On Windows pip wheels
          # often ship native DLLs in a sibling directory like `pyproj.libs`.
          lib_candidates = [
              pkg.parent / "pyproj.libs",
              pkg / ".libs",
              pkg / ".dylibs",
              pkg,
          ]
          existing_lib_dirs = [p for p in lib_candidates if p.exists()]
          if not existing_lib_dirs:
              raise SystemExit(
                  "PROJ library directory not found in pyproj package; checked: "
                  + ", ".join(str(p) for p in lib_candidates)
              )

          target_root = Path("zig_backend/vendor/proj")
          target_lib = target_root / "lib"
          target_data = target_root / "share" / "proj"
          if target_root.exists():
              shutil.rmtree(target_root)
          target_lib.mkdir(parents=True, exist_ok=True)
          target_data.parent.mkdir(parents=True, exist_ok=True)

          copied = 0
          seen_names = set()
          for lib_dir in existing_lib_dirs:
              for child in lib_dir.rglob("*"):
                  if not child.is_file():
                      continue
                  if child.suffix.lower() != ".dll":
                      continue
                  if child.name in seen_names:
                      continue
                  shutil.copy2(child, target_lib / child.name)
                  seen_names.add(child.name)
                  copied += 1
          if copied == 0:
              raise SystemExit(
                  "No DLLs copied from candidates: "
                  + ", ".join(str(p) for p in existing_lib_dirs)
              )

          shutil.copytree(proj_data, target_data, dirs_exist_ok=True)
          print("Prepared Windows PROJ assets:", target_root, f"(DLLs copied: {copied})")
          '@ | python -

      - name: Zig tests
        shell: pwsh
        working-directory: zig_backend
        run: |
          $projLib = (Resolve-Path "vendor/proj/lib").Path
          $projData = (Resolve-Path "vendor/proj/share/proj").Path
          $projDll = Get-ChildItem $projLib -Filter *.dll | Where-Object {
            $_.Name -match '^(proj|libproj).*\.dll$'
          } | Select-Object -First 1

          if (-not $projDll) {
            throw "PROJ DLL not found in $projLib"
          }

          $env:PATH = "$projLib;$env:PATH"
          $env:ZIG_PROJ_DYLIB = $projDll.FullName
          $env:ZIG_PROJ_DATA_DIR = $projData

          Write-Host "Using PROJ DLL: $($env:ZIG_PROJ_DYLIB)"
          Write-Host "Using PROJ data: $($env:ZIG_PROJ_DATA_DIR)"

          zig build test

      - name: Electron checks
        run: npm --prefix electron_app run check

      - name: Build Zig backend
        run: zig build
        working-directory: zig_backend

      - name: Prepare Electron runtime bundle
        run: npm --prefix electron_app run prepare:runtime

      - name: Build Windows portable EXE
        run: npm --prefix electron_app run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release version
        id: version
        shell: pwsh
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd.HHmm"
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $version = "v$timestamp-$shortSha"
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-electron-build
          path: electron_app/release/**

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: |
            Windows portable EXE (Electron frontend) + Zig backend runtime bundle.
          files: |
            electron_app/release/**/*.exe
